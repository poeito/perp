# ⏱️ 多策略检查周期错开示例

## 📊 2个策略示例（checkInterval = 30秒）

### 策略配置
```json
{
  "btc_conservative": {
    "checkInterval": 30000  // 30秒
  },
  "eth_moderate": {
    "checkInterval": 30000  // 30秒
  }
}
```

### 时间轴分析

**策略分配**：
- 策略1 (BTC): 初始延迟 = 0秒
- 策略2 (ETH): 初始延迟 = 15秒  (30秒 / 2策略 × 1)

```
时间轴：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0秒   [BTC✓] ←启动后立即检查
      |
15秒           [ETH✓] ←延迟15秒后首次检查
      |        |
30秒  [BTC✓]  |  ←第2次检查
      |        |
45秒           [ETH✓] ←第2次检查
      |        |
60秒  [BTC✓]  |
      |        |
75秒           [ETH✓]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 结果：两个策略完美错开15秒，不会同时请求API
```

---

## 📊 3个策略示例（checkInterval = 30秒）

### 策略配置
```json
{
  "btc_conservative": {
    "checkInterval": 30000
  },
  "btc_neutral": {
    "checkInterval": 30000
  },
  "eth_moderate": {
    "checkInterval": 30000
  }
}
```

### 时间轴分析

**策略分配**：
- 策略1 (BTC保守): 初始延迟 = 0秒
- 策略2 (BTC中性): 初始延迟 = 10秒  (30秒 / 3策略 × 1)
- 策略3 (ETH温和): 初始延迟 = 20秒  (30秒 / 3策略 × 2)

```
时间轴：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0秒   [BTC保守✓] 
      |
10秒       [BTC中性✓]
      |     |
20秒            [ETH✓]
      |     |     |
30秒  [BTC保守✓]  |     |
      |     |     |
40秒       [BTC中性✓]    |
      |     |     |
50秒            [ETH✓]
      |     |     |
60秒  [BTC保守✓]  |     |
      |     |     |
70秒       [BTC中性✓]    |
      |     |     |
80秒            [ETH✓]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 结果：三个策略完美错开10秒，API请求分散
```

---

## 📊 4个策略示例（不同checkInterval）

### 策略配置
```json
{
  "btc_conservative": {
    "checkInterval": 30000  // 30秒
  },
  "btc_neutral": {
    "checkInterval": 30000  // 30秒
  },
  "btc_aggressive": {
    "checkInterval": 20000  // 20秒
  },
  "eth_moderate": {
    "checkInterval": 30000  // 30秒
  }
}
```

### 时间轴分析

**策略分配**（使用各自的checkInterval）：
- 策略1: 延迟 0秒 (30秒间隔)
- 策略2: 延迟 7.5秒 (30秒间隔)
- 策略3: 延迟 10秒 (20秒间隔) ← 不同间隔
- 策略4: 延迟 22.5秒 (30秒间隔)

```
时间轴：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0秒   [保守✓]
      |
7.5秒    [中性✓]
      |   |
10秒      [激进✓]
      |   | |
22.5秒        [ETH✓]
      |   | |  |
30秒  [保守✓] |  |
      |   | |  |
      [中性✓] |  |  ← 30+7.5 = 37.5秒
      |   | |  |
      [激进✓] |  ← 30秒（20秒间隔×1.5）
      |   | |  |
      [ETH✓]   ← 52.5秒
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 结果：即使间隔不同，首次检查也会错开，减少冲突
```

---

## 📈 API请求密度对比

### ❌ 未优化前（同时请求）

```
API请求密度（2个策略，30秒间隔）：

0-5秒:   ██████ (2个请求)
5-10秒:  
10-15秒: 
15-20秒: 
20-25秒: 
25-30秒: ██████ (2个请求)  ← 同时请求，易触发限流
30-35秒: ██████ (2个请求)
...

峰值：2个请求/5秒窗口 = 0.4 QPS
```

### ✅ 优化后（错开请求）

```
API请求密度（2个策略，30秒间隔，错开15秒）：

0-5秒:   ███ (1个请求)
5-10秒:  
10-15秒: ███ (1个请求)     ← 错开
15-20秒: 
20-25秒: 
25-30秒: ███ (1个请求)
30-35秒: 
35-40秒: 
40-45秒: ███ (1个请求)     ← 均匀分布
...

峰值：1个请求/5秒窗口 = 0.2 QPS  ← 减少50%峰值压力
```

---

## 💡 实际运行日志示例

### 启动2个策略

```bash
$ node grid-multi-runner.js btc_conservative eth_moderate

⏱️  API限流保护:
   ✓ 策略依次启动（间隔3秒）
   ✓ 检查周期自动错开（避免同时请求API）

[1/2] 正在启动策略: btc_conservative...
🚀 启动网格交易策略...
⏱️  检查间隔: 30秒
⏱️  初始延迟: 0秒（错开检查周期）       ← 第1个策略，无延迟
✅ btc_conservative 启动成功

⏱️  等待 3 秒后启动下一个策略...

[2/2] 正在启动策略: eth_moderate...
🚀 启动网格交易策略...
⏱️  检查间隔: 30秒
⏱️  初始延迟: 15秒（错开检查周期）      ← 第2个策略，延迟15秒
✅ eth_moderate 启动成功

✅ 成功启动 2/2 个策略
```

### 运行中的检查周期

```
[00:00] BTC策略 - 首次检查  ✓
[00:15] ETH策略 - 首次检查  ✓  (延迟15秒后)
[00:30] BTC策略 - 定期检查  ✓
[00:45] ETH策略 - 定期检查  ✓
[01:00] BTC策略 - 定期检查  ✓
[01:15] ETH策略 - 定期检查  ✓
...

✅ 完美错开，不会同时请求API
```

---

## 🎯 最佳配置建议

### 2个策略（推荐配置）
```json
{
  "checkInterval": 30000  // 30秒间隔
}
```
- 错开时间：15秒
- API请求：每15秒1次
- ✅ 安全可靠

### 3个策略（推荐配置）
```json
{
  "checkInterval": 30000  // 30秒间隔
}
```
- 错开时间：10秒
- API请求：每10秒1次
- ✅ 安全可靠

### 4个策略（需谨慎）
```json
{
  "checkInterval": 40000  // 建议增加到40秒
}
```
- 错开时间：10秒
- API请求：每10秒1次
- ⚠️ 需要更大的检查间隔

### 5个以上（不推荐）
```json
{
  "checkInterval": 50000  // 建议增加到50秒
}
```
- 错开时间：10秒
- API请求：每10秒1次
- ⚠️ 建议分批运行或增加间隔

---

## 📊 计算公式

### 错开时间计算
```javascript
错开时间 = checkInterval / 策略数量
```

### 建议最小间隔
```javascript
最小checkInterval = 策略数量 × 10秒  // 确保每个策略至少错开10秒
```

**示例**：
- 2个策略：最小 20秒（推荐 30秒）
- 3个策略：最小 30秒（推荐 30秒）
- 4个策略：最小 40秒（推荐 40秒）
- 5个策略：最小 50秒（推荐 60秒）

---

## ✅ 验证方法

观察日志输出，确认：
1. 每个策略显示不同的 `初始延迟` 时间
2. 运行中的价格检查日志显示错开的时间戳
3. 没有出现 `API限流 (429)` 警告

---

**记住**：智能错开 = 更少限流 = 更稳定运行！ ⏱️✨

